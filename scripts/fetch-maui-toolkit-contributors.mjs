import { access, mkdir, writeFile } from 'node:fs/promises';
import { constants } from 'node:fs';
import { dirname, resolve } from 'node:path';

const OWNER = 'CommunityToolkit';
const REPO = 'Maui';
const PER_PAGE = 100;
const API_BASE = `https://api.github.com/repos/${OWNER}/${REPO}/contributors`;
const OUTPUT_PATH = resolve(process.cwd(), 'src/data/maui-toolkit-contributors.generated.ts');

const token =
  process.env.MAUI_TOOLKIT_CONTRIBUTORS_GITHUB_TOKEN ??
  process.env.MAUI_CONTRIBUTORS_GITHUB_TOKEN ??
  process.env.GITHUB_TOKEN ??
  process.env.GH_TOKEN;
const strictMode = /^(1|true|yes)$/i.test(process.env.MAUI_TOOLKIT_CONTRIBUTOR_SYNC_STRICT ?? '');
const forceRefresh = /^(1|true|yes)$/i.test(
  process.env.MAUI_TOOLKIT_CONTRIBUTOR_SYNC_FORCE_REFRESH ?? ''
);

function isBotLogin(login) {
  return /\[bot\]$/i.test(login) || /(?:^|[-_])bot(?:$|[-_])/i.test(login);
}

async function hasExistingDataset() {
  try {
    await access(OUTPUT_PATH, constants.F_OK);
    return true;
  } catch {
    return false;
  }
}

function toArrayLiteral(values) {
  if (values.length === 0) {
    return '[]';
  }

  return `[\n${values.map((value) => `  ${JSON.stringify(value)}`).join(',\n')}\n]`;
}

function buildOutput(usernames) {
  const fetchedAt = new Date().toISOString();
  const source = `${API_BASE}?per_page=${PER_PAGE}`;
  const valuesLiteral = toArrayLiteral(usernames);

  return `// This file is generated by scripts/fetch-maui-toolkit-contributors.mjs.\n// Do not edit manually.\n\nexport const mauiToolkitContributorSource = ${JSON.stringify(source)};\nexport const mauiToolkitContributorFetchedAt = ${JSON.stringify(fetchedAt)};\nexport const mauiToolkitContributorUsernames = ${valuesLiteral} as const;\n`;
}

function createHeaders() {
  const headers = {
    Accept: 'application/vnd.github+json',
    'User-Agent': 'mauiverse.net toolkit contributor sync',
    'X-GitHub-Api-Version': '2022-11-28',
  };

  if (token && token.trim().length > 0) {
    headers.Authorization = `Bearer ${token.trim()}`;
  }

  return headers;
}

async function fetchContributorsPage(page) {
  const url = `${API_BASE}?per_page=${PER_PAGE}&anon=0&page=${page}`;
  const response = await fetch(url, { headers: createHeaders() });

  if (!response.ok) {
    throw new Error(
      `Failed to fetch contributors page ${page}: ${response.status} ${response.statusText}`
    );
  }

  const data = await response.json();
  if (!Array.isArray(data)) {
    throw new Error('Unexpected response payload from GitHub contributors API.');
  }

  return data;
}

async function fetchAllContributorUsernames() {
  const usernames = new Set();

  for (let page = 1; ; page += 1) {
    const contributors = await fetchContributorsPage(page);
    if (contributors.length === 0) {
      break;
    }

    for (const contributor of contributors) {
      if (contributor?.type !== 'User') {
        continue;
      }

      const login = String(contributor?.login ?? '').trim();
      if (login.length === 0 || isBotLogin(login)) {
        continue;
      }

      usernames.add(login.toLowerCase());
    }

    if (contributors.length < PER_PAGE) {
      break;
    }
  }

  return Array.from(usernames).sort((left, right) => left.localeCompare(right));
}

async function writeDataset(usernames) {
  await mkdir(dirname(OUTPUT_PATH), { recursive: true });
  await writeFile(OUTPUT_PATH, buildOutput(usernames), 'utf8');
  console.log(`Wrote ${OUTPUT_PATH} (${usernames.length} usernames)`);
}

async function run() {
  if (!token) {
    console.warn(
      'No GitHub token found in MAUI_TOOLKIT_CONTRIBUTORS_GITHUB_TOKEN, MAUI_CONTRIBUTORS_GITHUB_TOKEN, GITHUB_TOKEN, or GH_TOKEN; continuing unauthenticated (lower rate limit).'
    );
  }

  try {
    const usernames = await fetchAllContributorUsernames();
    if (usernames.length === 0) {
      throw new Error('Contributor sync returned zero usernames.');
    }

    await writeDataset(usernames);
  } catch (error) {
    const existingDataset = await hasExistingDataset();
    if (existingDataset && !strictMode && !forceRefresh) {
      const reason = error instanceof Error ? error.message : String(error);
      console.warn(`Contributor sync failed; using existing dataset at ${OUTPUT_PATH}.`);
      console.warn(`Reason: ${reason}`);
      return;
    }

    throw error;
  }
}

run().catch((error) => {
  console.error(error instanceof Error ? error.message : String(error));
  process.exit(1);
});
